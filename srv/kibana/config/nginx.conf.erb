# see https://github.com/elasticsearch/kibana/blob/master/sample/nginx.conf
daemon off;
error_log <%= ENV['APP_LOG_DIR'] %>/nginx-access.log;
pid <%= ENV['APP_RUN_DIR'] %>/nginx.pid;

events {
    worker_connections 4096;
}

http {
    include /etc/nginx/mime.types;

    log_format combined_custom '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" $request_time';
    access_log <%= ENV['APP_LOG_DIR'] %>/nginx-access.log combined_custom;

    client_body_temp_path <%= ENV['APP_TMP_DIR'] %>/nginx-client-body-temp;

    gzip on;
    gzip_comp_level 2;
    gzip_disable "MSIE [1-6]\.(?!.*SV1)";
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types application/json;

    proxy_read_timeout 90;
    proxy_temp_path <%= ENV['APP_TMP_DIR'] %>/nginx-proxy-temp;

    server {
        listen *:80;
        server_name logsearch;

        location / {

            # Deny Nodes Shutdown API
            if ($request_filename ~ "_shutdown") {
              return 403;
              break;
            }

            # Deny All searches
            if ($request_filename ~ ^/_all/_search ) {
              return 403;
              break;
            }

            # Set a search timeout on all searchs
            if ($request_filename ~ ^/[^\/\*]+/_m?search$ ) {
                rewrite ^(.*)$ $1?timeout=15s break;
            }

# TODO add these restrictions
#            location ~ ^/_search/scroll$ {
#                limit_except GET {
#                    deny all;
#                }
#
#                proxy_pass http://elasticsearch;
#            }
#
#            location ~ ^/_cluster/(state|health) {
#                limit_except GET {
#                    deny all;
#                }
#
#                proxy_pass http://elasticsearch;
#            }
#
#            location ~ ^/_cluster/nodes {
#                limit_except GET {
#                    deny all;
#                }
#
#                proxy_pass http://elasticsearch;
#            }
#
#            location ~ ^/_nodes/stats {
#                limit_except GET {
#                    deny all;
#                }
#
#                proxy_pass http://elasticsearch;
#            }
#
#            location ~ ^/_(aliases|mapping|nodes|stats|status)$ {
#                limit_except GET {
#                    deny all;
#                }
#
#                proxy_pass http://elasticsearch;
#            }
#
#            location ~ ^/.*/(_aliases|_mapping|_stats|_status)$ {
#                limit_except GET {
#                    deny all;
#                }
#
#                proxy_pass http://elasticsearch;
#            }

            # Pass requests to ElasticSearch
            proxy_pass http://<%= ENV['APP_CONFIG_ES_IPADDRESS'] %>:9200;
            proxy_redirect off;

            proxy_set_header  X-Real-IP  $remote_addr;
            proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header  Host $http_host;

            # For CORS Ajax
            proxy_pass_header Access-Control-Allow-Origin;
            proxy_pass_header Access-Control-Allow-Methods;
            proxy_hide_header Access-Control-Allow-Headers;
            add_header Access-Control-Allow-Headers 'X-Requested-With, Content-Type';
            add_header Access-Control-Allow-Credentials true;
        }
    }
}
